files:
  /tmp/init.sh:
    mode: "000777"
    owner: root
    group: root
    content: |
      #!/bin/bash

      # modules
      sudo wget -r --no-parent -A 'epel-release-*.rpm' http://dl.fedoraproject.org/pub/epel/7/x86_64/Packages/e/;
      sudo rpm -Uvh dl.fedoraproject.org/pub/epel/7/x86_64/Packages/e/epel-release-*.rpm;
      sudo yum-config-manager --enable epel*;
      sudo yum update -y --skip-broken;
      sudo yum install dpkg -y;
      yum -y install fcgiwrap;
      systemctl start fcgiwrap@nginx.socket;
      systemctl enable fcgiwrap@nginx.socket;
      sudo yum -y install conntrack-tools;

      # letsEncrypt
      sudo yum install -y certbot python2-certbot-nginx;
      sudo yum install -y certbot-dns-route53;
      sudo certbot certonly --dns-route53 --dns-route53-propagation-seconds 30 -d *.${DOMAIN} --email ${EMAIL} -q --agree-tos;
      sudo ln -sf /etc/letsencrypt/live/${DOMAIN} /etc/letsencrypt/ebcert;

      # honeypot 파일
      echo $"fastcgi_intercept_errors off;" >> /etc/nginx/includes/honeypot.conf;
      echo $"include /etc/nginx/fastcgi_params;" >> /etc/nginx/includes/honeypot.conf;
      echo $"fastcgi_param SCRIPT_FILENAME /usr/local/libexec/block-ip.cgi;" >> /etc/nginx/includes/honeypot.conf;
      echo $"fastcgi_pass unix:/run/fcgiwrap/fcgiwrap-nginx.sock;" >> /etc/nginx/includes/honeypot.conf;

      # cgi 파일
      echo $"#!/bin/bash" >> /usr/local/libexec/block-ip.cgi;
      echo $"" >> /usr/local/libexec/block-ip.cgi;
      echo $"echo \"Status: 410 Gone\"" >> /usr/local/libexec/block-ip.cgi;
      echo $"echo \"Content-type: text/plain\"" >> /usr/local/libexec/block-ip.cgi;
      echo $"echo" >> /usr/local/libexec/block-ip.cgi;
      echo $"" >> /usr/local/libexec/block-ip.cgi;
      echo $"echo \"Bye bye, \$REMOTE_ADDR!\"" >> /usr/local/libexec/block-ip.cgi;
      echo $"sudo /usr/local/bin/block-ip.sh" >> /usr/local/libexec/block-ip.cgi;
      echo $"" >> /usr/local/libexec/block-ip.cgi;
      echo $"exit 0" >> /usr/local/libexec/block-ip.cgi;

      chmod 0755 /usr/local/libexec/block-ip.cgi;

      # sh 파일
      echo $"#!/bin/bash" >> /usr/local/bin/block-ip.sh;
      echo $"" >> /usr/local/bin/block-ip.sh;
      echo $"if [[ -z \${REMOTE_ADDR} ]]; then" >> /usr/local/bin/block-ip.sh;
      echo $"  if [[ -z \"\$1\"  ]]; then" >> /usr/local/bin/block-ip.sh;
      echo $"    echo \"REMOTE_ADDR not set!\"" >> /usr/local/bin/block-ip.sh;
      echo $"    exit 1" >> /usr/local/bin/block-ip.sh;
      echo $"  else" >> /usr/local/bin/block-ip.sh;
      echo $"    REMOTE_ADDR=\$1" >> /usr/local/bin/block-ip.sh;
      echo $"  fi" >> /usr/local/bin/block-ip.sh;
      echo $"fi" >> /usr/local/bin/block-ip.sh;
      echo $"" >> /usr/local/bin/block-ip.sh;
      echo $"# Put space separate list of trusted IP addresses, not to lock yourself out if you like to test the honeypot! \:\)" >> /usr/local/bin/block-ip.sh;
      echo $"TRUSTED_IPS=(127.0.0.1)" >> /usr/local/bin/block-ip.sh;
      echo $"if printf '%s\n' \${TRUSTED_IPS[@]} | grep -q -P \"^\$REMOTE_ADDR\\\$\"; then" >> /usr/local/bin/block-ip.sh;
      echo $"  echo \"Trusted IP\"" >> /usr/local/bin/block-ip.sh;
      echo $"  exit 0" >> /usr/local/bin/block-ip.sh;
      echo $"fi" >> /usr/local/bin/block-ip.sh;
      echo $"" >> /usr/local/bin/block-ip.sh;
      echo $"if [[ \"\$REMOTE_ADDR\" != \"\${1#*[0-9].[0-9]}\" ]]; then" >> /usr/local/bin/block-ip.sh;
      echo $"  /sbin/ipset add honeypot4 \${REMOTE_ADDR}" >> /usr/local/bin/block-ip.sh;
      echo $"  /sbin/conntrack -D -s \${REMOTE_ADDR}" >> /usr/local/bin/block-ip.sh;
      echo #"  echo "deny ${REMOTE_ADDR};" >> /etc/nginx/conf.d/blacklist.conf;" >>/usr/local/bin/block-ip.sh;
      echo #"  nginx -s reload" >>/usr/local/bin/block-ip.sh;
      echo $"elif [[ \"\$REMOTE_ADDR\" != \"\${1#*:[0-9a-fA-F]}\" ]]; then" >> /usr/local/bin/block-ip.sh;
      echo $"  /sbin/ipset add honeypot6 \${REMOTE_ADDR}" >> /usr/local/bin/block-ip.sh;
      echo $"  /sbin/conntrack -D -s \${REMOTE_ADDR}" >> /usr/local/bin/block-ip.sh;
      echo #"  echo "deny ${REMOTE_ADDR};" >> /etc/nginx/conf.d/blacklist.conf;" >>/usr/local/bin/block-ip.sh;
      echo #"  nginx -s reload" >>/usr/local/bin/block-ip.sh;
      echo $"else" >> /usr/local/bin/block-ip.sh;
      echo $"  echo \"Unrecognized Ip format '\$1'\"" >> /usr/local/bin/block-ip.sh;
      echo $"fi" >> /usr/local/bin/block-ip.sh;

      touch /etc/nginx/conf.d/blacklist.conf

      # nginx 권한
      echo $"Defaults!/usr/local/bin/block-ip.sh env_keep=REMOTE_ADDR" >> /etc/sudoers.d/nginx-block-ip;
      echo $"nginx ALL=(ALL) NOPASSWD: /usr/local/bin/block-ip.sh" >> /etc/sudoers.d/nginx-block-ip;

      firewall-cmd --reload;

      echo {\"type\": \"service_account\", \"project_id\": \"cultivated-cove-320001\",  \"private_key_id\": \"$CAPTCHA_KEY_ID\",     \"private_key\": \"$CAPTCHA_PEM\", \"client_email\": \"$CAPTCHA_EMAIL\",  \"client_id\": \"115405318409515778219\",     \"auth_uri\": \"https://accounts.google.com/o/oauth2/auth\",  \"token_uri\": \"https://oauth2.googleapis.com/token\",     \"auth_provider_x509_cert_url\": \"https://www.googleapis.com/oauth2/v1/certs\", \"client_x509_cert_url\":\" $CAPTCHA_X509\" } >> /home/ec2-user/credentials.json

      # elastic
      curl -L -O https://artifacts.elastic.co/downloads/beats/elastic-agent/elastic-agent-7.15.2-amd64.deb;
      sudo dpkg -i elastic-agent-7.15.2-amd64.deb;
      sudo rm elastic-agent-7.15.2-amd64.deb;
      sudo elastic-agent enroll --url=${FLEETURL} --enrollment-token=${FLEETTOKEN} -f && sudo systemctl enable elastic-agent && sudo systemctl start elastic-agent;

commands:
  01_remove_honeypot:
    command: "sh /tmp/init.sh"
    test: test ! -d /home/webapp/dl.fedoraproject.org
    ignoreErrors: true
  02_remove_init:
    command: "rm /tmp/init.sh"
    ignoreErrors: true
